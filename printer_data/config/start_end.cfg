[gcode_macro print_start]
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(240)|float %}

    {action_respond_info("Starting print preparations")}

    _status_heating
    # Start bed heating
    M140 S{BED_TEMP}
    # Preheat nozzle to 120
    M104 S120
    # Use absolute coordinates
    G90
    # Home the printer
    _status_homing
    _CG28

    # Level the gantry
    _status_leveling
    #_CQGL

    # Bed Mesh
    _status_meshing
    {action_respond_info("Bed meshing...")}
    BED_MESH_CALIBRATE

    _status_heating
    park

    {% if BED_TEMP >= 90 %} ; If bed is hot, it's a smelly material
        {action_respond_info("Hot bed means smelly. Pushing some air...")}
        UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION=0 ; stop stopping the filter
	SET_FAN_SPEED FAN=nevermore SPEED=0.6
    {% endif %}

    # Set and wait for nozzle to reach temperature
    _status_heating
    {action_respond_info("Preheating")}
    M109 S{EXTRUDER_TEMP}
    # Wait for bed to reach temperature
    M190 S{BED_TEMP}

    {action_respond_info("Cleaning")}
    _status_cleaning
    CLEAN_NOZZLE PURGE=1
    #CALIBRATE_Z 

    {action_respond_info("Beginning print!")}
    G90
    _status_printing

[gcode_macro print_end]
description: Inserted by slicer at end of print.
  Usage: PRINT_END
gcode:
    _KM_CHECK_IS_PRINTING
    M400

    CLEAN_NOZZLE PURGE=1
    G91
    #G1 E-10 F1000 ; retract
    G10

    M220 S100
    M221 S100

    UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION=300

    TURN_OFF_HEATERS
    M107; turn off fan

  {% if printer.bed_mesh %}BED_MESH_CLEAR{% endif %}
  # Park the toolhead and present the bed
  {% if printer.toolhead.homed_axes|lower == "xyz" %}
    PARK
  {% endif %}
  M84 ; disable steppers
  CLEAR_PAUSE
  _status_ready

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} ; set timeout back to configured value
    CLEAR_PAUSE
    PRINT_END
    BASE_CANCEL_PRINT

[gcode_macro _km_check_is_printing]
variable_debug_state: False # Disables print state check for debugging.
description: Throws an error if print is not currently in progress.
gcode:
  {% if not debug_state and
        printer.idle_timeout.state|string != "Printing" and
        not (printer.virtual_sdcard|default({})).is_active|default(False) and
        not printer.pause_resume.is_paused %}
    { action_raise_error("No active print.") }
  {% endif %}
